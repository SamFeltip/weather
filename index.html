<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bitcount+Grid+Double:wght@100..900&family=Figtree:ital,wght@0,300..900;1,300..900&family=Geist:wght@100..900&family=Unbounded:wght@200..900&display=swap"
      rel="stylesheet"
    />
    <style>
      #current-weather {
        position: absolute;
        top: 16px;
        left: 16px;
        gap: 4px;
        display: flex;
        align-items: center;
        color: white;
        font-family: "Figtree";
        font-size: 20px;

        & svg {
          width: 54px;
          height: 54px;
          margin-bottom: 10px;
        }

        #current-temp {
          margin-bottom: 16px;
        }
      }

      .weather-wrapper {
        position: relative;
        height: 100%;
      }

      /* both stacked in same place */
      .last-weather,
      .next-weather {
        position: absolute;
        inset: 0;
        transition:
          opacity 0.2s ease,
          visibility 0.2s ease;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      /* visible states */
      .show-last-weather .last-weather {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .show-next-weather .next-weather {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
    </style>
  </head>
  <body
    class="show-last-weather"
    style="
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(to bottom, #4fc3f7, #81d4fa);
    "
  >
    <div id="current-weather" style="display: none">
      <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
        <path
          d="M320 64C214 64 128 148.4 128 252.6C128 371.9 248.2 514.9 298.4 569.4C310.2 582.2 329.8 582.2 341.6 569.4C391.8 514.9 512 371.9 512 252.6C512 148.4 426 64 320 64z"
        />
      </svg> -->
      <svg id="current-weather-icon"></svg>
      <span id="current-temp">
        <span id="current-temp-content"></span>&deg;C
      </span>
    </div>

    <div id="rain-timeline">
      <ul>
        <li>one</li>
        <li>two</li>
        <li>three</li>
        <li>four</li>
        <li>five</li>
        <li>six</li>
      </ul>
    </div>
    <div
      id="weatherGrid"
      style="
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto;
        align-items: center;
        gap: 3.5rem;
        padding: 3rem;
      "
    >
      <svg
        id="rain"
        width="120"
        height="120"
        viewBox="0 0 64 64"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g fill="#bbdefb">
          <circle cx="32" cy="24" r="13" />
          <circle cx="18" cy="32" r="10" />
          <circle cx="46" cy="32" r="10" />
          <rect x="18" y="30" width="28" height="12" />
        </g>

        <line
          x1="24"
          y1="48"
          x2="20"
          y2="58"
          stroke="#1e88e5"
          stroke-width="4"
          stroke-linecap="round"
        />
        <line
          x1="36"
          y1="50"
          x2="32"
          y2="60"
          stroke="#1e88e5"
          stroke-width="4"
          stroke-linecap="round"
        />
        <line
          x1="48"
          y1="48"
          x2="44"
          y2="58"
          stroke="#1e88e5"
          stroke-width="4"
          stroke-linecap="round"
        />
      </svg>
      <span id="rain-weather" class="weather-wrapper"></span>
      <svg id="snow" width="120" height="120" viewBox="0 0 64 64" fill="none">
        <circle cx="32" cy="32" r="5" fill="#e3f2fd" />
        <g stroke="#e3f2fd" stroke-width="4">
          <line x1="32" y1="8" x2="32" y2="56" />
          <line x1="8" y1="32" x2="56" y2="32" />
          <line x1="18" y1="18" x2="46" y2="46" />
          <line x1="46" y1="18" x2="18" y2="46" />
        </g>
      </svg>
      <span id="snow-weather" class="weather-wrapper"></span>
      <svg
        id="sunshine"
        width="120"
        height="120"
        viewBox="0 0 64 64"
        fill="none"
      >
        <circle cx="32" cy="32" r="14" fill="#ffeb3b" />
        <g stroke="#fbc02d" stroke-width="4">
          <line x1="32" y1="2" x2="32" y2="16" />
          <line x1="32" y1="48" x2="32" y2="62" />
          <line x1="2" y1="32" x2="16" y2="32" />
          <line x1="48" y1="32" x2="62" y2="32" />
          <line x1="12" y1="12" x2="22" y2="22" />
          <line x1="42" y1="42" x2="52" y2="52" />
          <line x1="42" y1="22" x2="52" y2="12" />
          <line x1="12" y1="52" x2="22" y2="42" />
        </g>
      </svg>
      <span id="sun-weather" class="weather-wrapper"></span>
      <svg
        id="clouds"
        width="120"
        height="120"
        viewBox="0 0 64 64"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g fill="#bbdefb">
          <circle cx="32" cy="24" r="13" />
          <circle cx="18" cy="32" r="10" />
          <circle cx="46" cy="32" r="10" />
          <rect x="18" y="30" width="28" height="12" />
        </g>
      </svg>
      <span id="cloud-weather" class="weather-wrapper"></span>
    </div>

    <script>
      //@ts-check

      // Clear skies
      const CLEAR = 0;
      const MAINLY_CLEAR = 1;

      // Partly cloudy / overcast
      const PARTLY_CLOUDY = 2;
      const OVERCAST = 3;

      // Rain / Showers
      const DRIZZLE_LIGHT = 51;
      const DRIZZLE_MODERATE = 53;
      const DRIZZLE_HEAVY = 55;
      const RAIN_LIGHT = 61;
      const RAIN_MODERATE = 63;
      const RAIN_HEAVY = 65;
      const SHOWERS_SLIGHT = 80;
      const SHOWERS_MODERATE = 81;
      const SHOWERS_VIOLENT = 82;

      // Snow / Snow Showers
      const SNOW_LIGHT = 71;
      const SNOW_MODERATE = 73;
      const SNOW_HEAVY = 75;
      const SNOW_GRAINS = 77;
      const SNOW_SHOWERS_SLIGHT = 85;
      const SNOW_SHOWERS_HEAVY = 86;

      const LATITUDE = 53.3676;
      const LONGITUDE = -1.5023;

      const MS_PER_DAY = 1000 * 60 * 60 * 24;
      const WEATHER_THRESHOLDS = {
        [CLEAR]: 3,
        [MAINLY_CLEAR]: 4,
        [PARTLY_CLOUDY]: 6,
        [OVERCAST]: 5,
        [DRIZZLE_LIGHT]: 4,
        [DRIZZLE_MODERATE]: 4,
        [DRIZZLE_HEAVY]: 4,
        [RAIN_LIGHT]: 5,
        [RAIN_MODERATE]: 5,
        [RAIN_HEAVY]: 3,
        [SHOWERS_SLIGHT]: 3,
        [SHOWERS_MODERATE]: 2,
        [SHOWERS_VIOLENT]: 2,
        [SNOW_GRAINS]: 4,
        [SNOW_LIGHT]: 4,
        [SNOW_MODERATE]: 3,
        [SNOW_HEAVY]: 1,
        [SNOW_SHOWERS_SLIGHT]: 2,
        [SNOW_SHOWERS_HEAVY]: 2,
      }; // minimum number of hours in a day with the weather code to count as an occurrence

      const RAIN_THRESHOLD = 1; // in mm
      const SNOW_THRESHOLD = 0.5; // in cm

      /** @param {Date} date */
      function getHumanReadableTimePeriod(date) {
        const today = new Date();
        const diff = Math.floor(
          (today.getTime() - date.getTime()) / MS_PER_DAY,
        );
        if (diff === 0) return "earlier today";
        if (diff === 1) return "yesterday";
        if (diff < 7) return `${diff} days ago`;
        if (diff == 7) return `last week`;
        if (diff < 60) return `${Math.floor(diff / 7)} weeks ago`;

        return `${Math.floor(diff / 30)} months ago`;
      }

      /**
       * @param {string} weatherType
       * @param {{ diff: number, date: Date } | null } nextData
       * @returns {string}
       * */
      function getHumanReadableFutureDate(weatherType, nextData) {
        if (!nextData) return `no ${weatherType} for a while`;

        const { diff, date } = nextData;
        if (diff === 0) return `${weatherType} later today`;
        if (diff === 1) return `${weatherType} tomorrow`;
        if (diff < 7) return `${weatherType} in ${diff} days`;
        if (diff == 7) return `${weatherType} next week`;
        if (diff < 60) return `${weatherType} in ${Math.floor(diff / 7)} weeks`;

        return `${weatherType} in ${Math.floor(diff / 30)} months`;
      }

      const weatherTypes = {
        rain: {
          elemId: "rain-weather",
          codes: [
            DRIZZLE_LIGHT,
            DRIZZLE_MODERATE,
            DRIZZLE_HEAVY,
            RAIN_LIGHT,
            RAIN_MODERATE,
            RAIN_HEAVY,
            SHOWERS_SLIGHT,
            SHOWERS_MODERATE,
            SHOWERS_VIOLENT,
            SNOW_SHOWERS_SLIGHT,
            SNOW_SHOWERS_HEAVY,
          ],
        },
        snow: {
          elemId: "snow-weather",
          codes: [
            SNOW_LIGHT,
            SNOW_MODERATE,
            SNOW_GRAINS,
            SNOW_HEAVY,
            SNOW_SHOWERS_SLIGHT,
            SNOW_SHOWERS_HEAVY,
          ],
        },
        sunshine: {
          elemId: "sun-weather",
          codes: [CLEAR, MAINLY_CLEAR],
        },
        clouds: {
          elemId: "cloud-weather",
          codes: [PARTLY_CLOUDY, OVERCAST],
        },
      };

      /**
       * @param {string} elemId
       * @param {{last: { diff: number, date: Date } | null, next: { diff: number, date: Date } | null}} data
       */
      function createCell(elemId, key, data) {
        const elem = document.getElementById(elemId);
        if (!elem) {
          console.warn(`[Weather] Element with ID '${elemId}' not found`);
          return "";
        }

        elem.innerHTML = `
                  <span class="last-weather">
                ${
                  data?.last
                    ? `
                <h2 style="margin:0;text-align:center;font-size:72px;font-weight:300;color:white;font-family: Bitcount Grid Double;">${data.last.diff}</h2>
                    <p style="margin:0;margin-bottom:12px;font-family:Figtree;color:white;text-align:center;opacity: 0.65;">${getHumanReadableTimePeriod(data.last.date)}</p>
                    `
                    : `
                    <h2 style="margin:0;text-align:center;font-size:72px;font-weight:300;color:white;font-family: Bitcount Grid Double;">unknown</h2>
                    `
                }
                  </span>
                  <span class="next-weather">
                    <h2 style="margin:0;text-align:center;font-size:72px;font-weight:300;color:white;font-family: Bitcount Grid Double;">${data?.next?.diff ?? "n/a"}</h2>
                    <p style="margin:0;font-family:Figtree;color:white;text-align:center;opacity: 0.65;">${getHumanReadableFutureDate(key, data.next)}</p>
                  </span>

            `;
      }

      async function fetchRange() {
        const hourly_params = ["weather_code"];
        const daily_params = [
          "rain_sum",
          "showers_sum",
          "snowfall_sum",
          "precipitation_sum",
        ];

        const url = new URL("https://api.open-meteo.com/v1/forecast");
        url.search = new URLSearchParams({
          latitude: LATITUDE.toString(),
          longitude: LONGITUDE.toString(),
          hourly: hourly_params.join(","),
          daily: daily_params.join(","),
          past_days: "60",
          forecast_days: "16",
          timezone: "auto",
        }).toString();

        console.log("[Weather] Request URL:", url);

        try {
          const res = await fetch(url);
          if (!res.ok) return null;
          const data = await res.json();
          if (!data || !data.hourly || !data.hourly.time) return null;
          return data;
        } catch (err) {
          console.log("[Weather] API error:", err);
          return null;
        }
      }

      async function fetchWeather() {
        const today = new Date();
        const maxLookbackDays = 365 * 5;

        const results = {};
        for (const key in weatherTypes)
          results[key] = { last: null, next: null };

        const data = await fetchRange();
        if (!data) {
          return null;
        }

        const hours = data.hourly.time.map((t) => new Date(t));
        const codes = data.hourly.weather_code;
        const days = data.daily.time.map((t) => new Date(t));

        for (const key in weatherTypes) {
          console.debug(`[Weather] ${key}`);

          // Group by day
          const dailyData = days.map((day, index) => ({
            date: day,
            rain: data.daily.rain_sum[index] || 0,
            showers: data.daily.showers_sum[index] || 0,
            snow: data.daily.snowfall_sum[index] || 0,
          }));

          const dailyCounts = {};
          hours.forEach((hour, index) => {
            const dayKey = hour.toISOString().split("T")[0];
            if (!dailyCounts[dayKey]) dailyCounts[dayKey] = {};

            const code = codes[index];
            if (!dailyCounts[dayKey][code]) dailyCounts[dayKey][code] = 0;
            dailyCounts[dayKey][code]++;
          });

          // Find the last occurrence
          for (const daily of dailyData.reverse()) {
            const dayKey = daily.date.toISOString().split("T")[0];
            const isRainy =
              key === "rain" && daily.rain + daily.showers >= RAIN_THRESHOLD;
            const isSnowy = key === "snow" && daily.snow >= SNOW_THRESHOLD;
            const isSunny =
              key === "sunshine" &&
              weatherTypes[key].codes.some(
                (code) => dailyCounts[dayKey]?.[code],
              );
            const isCloudy =
              key === "clouds" &&
              weatherTypes[key].codes.some(
                (code) => dailyCounts[dayKey]?.[code],
              );

            if (isRainy || isSnowy || isSunny || isCloudy) {
              const lastDate = daily.date;
              const diff = Math.floor(
                (today.getTime() - lastDate.getTime()) / MS_PER_DAY,
              );

              if (diff < 0) {
                continue;
              }

              console.debug(
                `[Weather] Found last ${key} on ${lastDate.toISOString().split("T")[0]} (${diff} days ago)`,
              );
              results[key].last = { diff, date: lastDate };
              break;
            }
          }

          // Find the next occurrence
          for (const daily of dailyData.reverse()) {
            const dayKey = daily.date.toISOString().split("T")[0];
            const isRainy =
              key === "rain" && daily.rain + daily.showers >= RAIN_THRESHOLD;
            const isSnowy = key === "snow" && daily.snow >= SNOW_THRESHOLD;
            const isSunny =
              key === "sunshine" &&
              weatherTypes[key].codes.some(
                (code) => dailyCounts[dayKey]?.[code],
              );
            const isCloudy =
              key === "clouds" &&
              weatherTypes[key].codes.some(
                (code) => dailyCounts[dayKey]?.[code],
              );

            if (isRainy || isSnowy || isSunny || isCloudy) {
              const nextDate = daily.date;
              const diff = Math.floor(
                (nextDate.getTime() - today.getTime()) / MS_PER_DAY,
              );

              if (diff < 0) {
                continue;
              }

              console.debug(
                `[Weather] Found next ${key} on ${nextDate.toISOString().split("T")[0]} (in ${diff} days)`,
              );
              results[key].next = { diff, date: nextDate };
              break;
            }
          }
        }

        Object.entries(weatherTypes)
          .map(([key, val]) => createCell(val.elemId, key, results[key]))
          .join("");
      }

      async function fetchCurrentWeather() {
        const hourly_params = [
          "temperature_2m",
          "weather_code",
          "rain",
          "showers",
          "snowfall",
          "snow_depth",
          "cloud_cover_low",
          "cloud_cover_mid",
          "cloud_cover_high",
        ];

        const params = new URLSearchParams({
          latitude: LATITUDE.toString(),
          longitude: LONGITUDE.toString(),
          hourly: hourly_params.join(","),
          forecast_days: "1",
        });

        const url = new URL("https://api.open-meteo.com/v1/forecast");
        url.search = params.toString();

        console.debug("[Weather] Fetching current weather:", url.toString());

        const res = await fetch(url);
        if (!res.ok) {
          console.error("Failed to fetch current weather:", res.statusText);
          throw new Error(`Failed to fetch current weather: ${res.statusText}`);
        }

        const data = await res.json();
        if (!data || !data.hourly || !data.hourly.time) {
          console.error("Invalid weather data format");
          throw new Error("Invalid weather data format");
        }

        const currentHour = new Date().getHours();
        const currentWeatherCode = data.hourly.weather_code[currentHour];
        const currentTemperature = data.hourly.temperature_2m[currentHour];

        console.log(
          `Current weather code: ${currentWeatherCode}, temperature: ${currentTemperature}°C`,
        );
        return { currentWeatherCode, currentTemperature };
      }

      fetchWeather().then(() => {
        // Select all SVG elements
        const svgs = document.querySelectorAll("svg");

        // Animation function
        function animateSVGs() {
          svgs.forEach((svg) => {
            svg.animate(
              [
                { transform: "scale(1)" },
                { transform: "scale(1.1)" },
                { transform: "scale(1)" },
              ],
              {
                duration: 200, // total animation time (ms)
                easing: "ease-in-out",
              },
            );
          });

          if (document.body.classList.contains("show-last-weather")) {
            document.body.classList.remove("show-last-weather");
            document.body.classList.add("show-next-weather");
          } else if (document.body.classList.contains("show-next-weather")) {
            document.body.classList.remove("show-next-weather");
            document.body.classList.add("show-last-weather");
          } else {
            document.body.classList.add("show-last-weather");
          }
        }

        // Trigger on click / tap
        window.addEventListener("pointerdown", animateSVGs);

        // Trigger on any key press
        window.addEventListener("keydown", animateSVGs);
      });

      fetchCurrentWeather().then(
        ({ currentWeatherCode, currentTemperature }) => {
          console.log(
            `Current weather code: ${currentWeatherCode}, temperature: ${currentTemperature}°C`,
          );

          const weatherType = Object.keys(weatherTypes).find((key) =>
            weatherTypes[key].codes.includes(currentWeatherCode),
          );

          console.log(`Current weather type: ${weatherType}`);

          const currentWeatherElem = document.getElementById("current-weather");
          if (!currentWeatherElem) {
            console.warn(
              "[Weather] Element with ID 'current-weather' not found",
            );
            return;
          }

          const weatherSvg = document.querySelector(`svg#${weatherType}`);

          if (!weatherSvg) {
            console.warn(
              `[Weather] SVG element for weather type '${weatherType}' not found`,
            );
            return;
          }

          const currentWeatherSvg = currentWeatherElem.querySelector(
            "svg#current-weather-icon",
          );
          if (!currentWeatherSvg) {
            console.warn(
              "[Weather] No SVG found inside 'currentWeather' element",
            );
            return;
          }

          currentWeatherSvg.outerHTML = weatherSvg.outerHTML;

          const currentWeatherTemp = document.getElementById(
            "current-temp-content",
          );
          if (!currentWeatherTemp) {
            console.warn(
              "[Weather] Element with ID 'current-temp-content' not found",
            );
            return;
          }

          currentWeatherTemp.textContent = currentTemperature.toString();

          currentWeatherElem.style.display = "inherit";
        },
      );
    </script>
  </body>
</html>
