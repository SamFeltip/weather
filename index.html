<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex items-center justify-center" style="background: linear-gradient(to bottom, #4fc3f7, #81d4fa);">

  <div id="weatherGrid" class="grid grid-cols-1 gap-14 p-12"></div>

<script>
const latitude = 53.38;
const longitude = -1.47;

const weatherTypes = {
  rain: {
    svg: `<svg width="120" height="120" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="26" rx="18" ry="12" fill="#90caf9"/><circle cx="24" cy="24" r="10" fill="#bbdefb"/><circle cx="40" cy="24" r="10" fill="#bbdefb"/><line x1="22" y1="40" x2="18" y2="54" stroke="#1e88e5" stroke-width="4"/><line x1="32" y1="40" x2="28" y2="54" stroke="#1e88e5" stroke-width="4"/><line x1="42" y1="40" x2="38" y2="54" stroke="#1e88e5" stroke-width="4"/></svg>`,
    codes: [51,53,55,61,63,65,80,81,82]
  },
  snow: {
    svg: `<svg width="120" height="120" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="5" fill="#e3f2fd"/><g stroke="#e3f2fd" stroke-width="4"><line x1="32" y1="8" x2="32" y2="56"/><line x1="8" y1="32" x2="56" y2="32"/><line x1="18" y1="18" x2="46" y2="46"/><line x1="46" y1="18" x2="18" y2="46"/></g></svg>`,
    codes: [71,73,75,85,86]
  },
  sunshine: {
    svg: `<svg width="120" height="120" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="14" fill="#ffeb3b"/><g stroke="#fbc02d" stroke-width="4"><line x1="32" y1="2" x2="32" y2="16"/><line x1="32" y1="48" x2="32" y2="62"/><line x1="2" y1="32" x2="16" y2="32"/><line x1="48" y1="32" x2="62" y2="32"/><line x1="12" y1="12" x2="22" y2="22"/><line x1="42" y1="42" x2="52" y2="52"/><line x1="42" y1="22" x2="52" y2="12"/><line x1="12" y1="52" x2="22" y2="42"/></g></svg>`,
    codes: [0]
  },
  clouds: {
    svg: `<svg width="120" height="120" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="36" rx="18" ry="12" fill="#eceff1"/><circle cx="24" cy="32" r="10" fill="#cfd8dc"/><circle cx="40" cy="32" r="10" fill="#cfd8dc"/></svg>`,
    codes: [1,2,3]
  }
};

function createCell(svg, days) {
  return `
    <div class="flex items-center gap-8 justify-center">
      ${svg}
      <div style="font-size:72px;font-weight:700;color:white">${days}</div>
    </div>
  `;
}

async function fetchRange(start, end) {
  const format = d => d.toISOString().split('T')[0];
  const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&daily=weathercode&timezone=auto&start_date=${format(start)}&end_date=${format(end)}`;

  console.log("[Weather] Request URL:", url);

  try {
    const res = await fetch(url);
    if (!res.ok) return null;
    const data = await res.json();
    if (!data || !data.daily || !data.daily.time) return null;
    return data;
  } catch (err) {
    console.log("[Weather] API error:", err);
    return null;
  }
}

async function fetchWeather() {
  const today = new Date();
  const maxLookbackDays = 365 * 5;

  const results = {};
  for (const key in weatherTypes) results[key] = null;

  let checkedDays = 0;
  let end = new Date(today);

  while (checkedDays < maxLookbackDays && Object.values(results).some(v => v === null)) {
    const start = new Date(end);
    start.setDate(start.getDate() - 89);

    const data = await fetchRange(start, end);
    let foundAny = false;

    if (data) {
      const days = data.daily.time;
      const codes = data.daily.weathercode;

      for (const key in weatherTypes) {
        if (results[key] !== null) continue;
        const matchCodes = weatherTypes[key].codes;

        for (let i = codes.length - 1; i >= 0; i--) {
          if (matchCodes.includes(codes[i])) {
            const lastDate = new Date(days[i]);
            const diff = Math.floor((today - lastDate) / (1000*60*60*24));
            console.log(`[Weather] Found ${key} on ${days[i]} (${diff} days ago)`);
            results[key] = diff;
            foundAny = true;
            break;
          }
        }
      }
    }

    if (!foundAny) {
      console.log("[Weather] Nothing found in this block, requesting older data...");
    }

    checkedDays += 90;
    end = new Date(start);
    end.setDate(end.getDate() - 1);
  }

  for (const key in results) {
    if (results[key] === null) {
      console.log(`[Weather] No ${key} found in lookback window`);
      results[key] = "â€”";
    }
  }

  const grid = document.getElementById("weatherGrid");
  grid.innerHTML = Object.entries(weatherTypes)
    .map(([key, val]) => createCell(val.svg, results[key]))
    .join("");
}

fetchWeather();
</script>

</body>
</html>
